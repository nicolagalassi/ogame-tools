<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production | OValue</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { ogame: { bg: '#0d1014', panel: '#161b22', border: '#30363d', accent: '#3399ff', success: '#238636', danger: '#da3633', warning: '#d29922', text: '#c9d1d9' } }, fontFamily: { sans: ['Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'], mono: ['Consolas', 'Monaco', 'monospace'] } } } }
    </script>
    <style>
        input[type=number]::-webkit-inner-spin-button{opacity:0}input[type=number]:hover::-webkit-inner-spin-button{opacity:1}
        .tooltip{visibility:hidden;background-color:#333;color:#fff;text-align:center;border-radius:6px;padding:5px 10px;position:absolute;z-index:10;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .3s;font-size:10px;white-space:nowrap;box-shadow:0 2px 5px rgba(0,0,0,.5)}.group:hover .tooltip{visibility:visible;opacity:1}
    </style>
</head>
<body class="bg-ogame-bg text-ogame-text font-sans pb-32 min-h-screen">

    <header class="relative bg-gradient-to-b from-[#1c2128] to-ogame-bg border-b border-ogame-border pt-8 pb-12 px-4 mb-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <a href="index.html" class="inline-flex items-center text-sm text-gray-500 hover:text-ogame-accent transition mb-2 group">
                    <svg class="w-4 h-4 mr-1 transform group-hover:-translate-x-1 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    <span data-i18n="nav_back">Torna a OValue</span>
                </a>
                <h1 class="text-3xl md:text-5xl font-bold text-white tracking-tight">
                    <span data-i18n="metal_calc_title">Production Core</span>
                </h1>
                <p class="text-gray-400 mt-2 max-w-xl text-sm md:text-base" data-i18n="metal_calc_desc">
                    Ottimizza la produzione...
                </p>
            </div>
            
            <div class="flex gap-2 bg-ogame-panel p-2 rounded-xl border border-ogame-border shadow-lg">
                <button onclick="exportData()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-gray-800 transition text-gray-400 hover:text-white group" title="Salva">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    <span class="text-[9px] uppercase font-bold" data-i18n="btn_save">Salva</span>
                </button>
                
                <div class="w-px bg-gray-700 my-2"></div>
                
                <button onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-gray-800 transition text-gray-400 hover:text-white group" title="Carica">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span class="text-[9px] uppercase font-bold" data-i18n="btn_load">Carica</span>
                </button>
                
                <div class="w-px bg-gray-700 my-2"></div>
                
                <button onclick="resetAll()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-red-900/20 transition text-gray-400 hover:text-ogame-danger group" title="Reset">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span class="text-[9px] uppercase font-bold" data-i18n="btn_reset">Reset</span>
                </button>
                <input type="file" id="fileInput" accept=".json" onchange="importData(this)" class="hidden">

                <div class="w-px bg-gray-700 my-2"></div>

                <div class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-gray-800 transition text-gray-400 hover:text-white group relative cursor-pointer" title="Lingua/Language">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg>
                    <span id="langLabel" class="text-[9px] font-bold uppercase pointer-events-none">IT</span>
                    <select id="langSelector" onchange="setLanguage(this.value)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <option value="it" style="background-color: #161b22; color: #c9d1d9;">Italiano</option>
                        <option value="en" style="background-color: #161b22; color: #c9d1d9;">English</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 md:px-6">
        
        <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-ogame-accent"></div>
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-ogame-accent"></span> <span data-i18n="settings_title">Impostazioni Account & Universo</span>
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="lbl_eco_speed">Velocit√† Economia</label>
                        <input type="number" id="ecoSpeed" value="8" min="1" onchange="calculateAll()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent outline-none font-mono">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="lbl_player_class">Classe Giocatore</label>
                        <select id="playerClass" onchange="calculateAll()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent outline-none">
                            <option value="collector" data-i18n="opt_collector">Collector (+25%)</option>
                            <option value="other" data-i18n="opt_general">Explorer/General</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="lbl_plasma">Livello Plasma</label>
                        <input type="number" id="plasmaLevel" value="0" min="0" onchange="calculateAll()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent outline-none">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="lbl_lf_bonus">Bonus LifeForms Totale (%)</label>
                        <input type="number" id="lfGlobalBonus" value="0" placeholder="0" onchange="calculateAll()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent outline-none">
                    </div>
                </div>
                <div class="space-y-4 pt-1">
                    <label class="flex items-center p-3 rounded-lg border border-gray-700/50 hover:border-gray-600 bg-[#0d1014]/50 cursor-pointer group">
                        <input type="checkbox" id="geologist" onchange="calculateAll()" class="w-5 h-5 accent-ogame-accent rounded bg-gray-800 border-gray-600">
                        <span class="ml-3 font-medium text-gray-300" data-i18n="lbl_geo">Geologo (+10%)</span>
                    </label>
                    <label class="flex items-center p-3 rounded-lg border border-gray-700/50 hover:border-gray-600 bg-[#0d1014]/50 cursor-pointer group">
                        <input type="checkbox" id="staff" onchange="calculateAll()" class="w-5 h-5 accent-ogame-accent rounded bg-gray-800 border-gray-600">
                        <span class="ml-3 font-medium text-gray-300" data-i18n="lbl_staff">Staff Comando (+2%)</span>
                    </label>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="lbl_ally_class">Classe Alleanza</label>
                        <select id="allyClass" onchange="calculateAll()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-300 focus:border-ogame-accent outline-none">
                            <option value="none" data-i18n="opt_none">Nessuna</option>
                            <option value="trader" data-i18n="opt_trader">Mercante (+5%)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-[#11161d] border border-ogame-accent/30 rounded-xl p-4 mb-8 shadow-lg flex flex-col md:flex-row items-center gap-4">
            <div class="flex items-center gap-2 text-ogame-accent whitespace-nowrap">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span class="font-bold text-sm uppercase tracking-wide" data-i18n="bulk_title">Modifica Massiva</span>
            </div>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-3 w-full">
                <select id="bulkTarget" class="w-full bg-[#0d1014] border border-gray-700 rounded px-3 py-2 text-white text-sm focus:border-ogame-accent outline-none">
                    <option value="metal" data-i18n="lbl_mine_metal">Miniera Metallo</option>
                    <option value="crystal" data-i18n="lbl_mine_crystal">Miniera Cristallo</option>
                    <option value="deuterium" data-i18n="lbl_mine_deuterium">Miniera Deuterio</option>
                    <option value="item" data-i18n="lbl_item">Item Metallo (%)</option>
                    <option value="itemCustom">Item Custom (%)</option>
                    <option value="pos" data-i18n="lbl_position">Posizione</option>
                    <option value="magma" data-i18n="lbl_magma">Magma Forge</option>
                    <option value="human" data-i18n="lbl_human">HE Smelting (Umani)</option>
                    <option value="crawlers" data-i18n="lbl_crawlers">Crawler Assegnati</option>
                    <option value="overload" data-i18n="lbl_overload">Crawler Overload</option>
                </select>
                <input type="number" id="bulkValue" data-i18n="bulk_placeholder" placeholder="Nuovo Valore" class="w-full bg-[#0d1014] border border-gray-700 rounded px-3 py-2 text-white text-sm focus:border-ogame-accent outline-none font-mono">
                <button onclick="applyBulk()" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm transition shadow-md" data-i18n="btn_bulk_apply">Applica a Tutti</button>
            </div>
        </div>

        <div class="flex flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-3">
                <span data-i18n="planet_mgmt">Gestione Pianeti</span>
                <span class="text-xs md:text-sm font-normal text-gray-400 bg-gray-800 px-2 py-1 rounded-md border border-gray-700" id="planetCountBadge">0</span>
            </h2>
            <button onclick="addPlanet()" class="px-4 py-2 md:px-6 md:py-2 bg-ogame-success hover:bg-green-600 text-white text-sm md:text-base font-bold rounded-lg shadow-lg hover:shadow-green-900/30 transition transform hover:-translate-y-0.5 flex items-center gap-2 whitespace-nowrap">
                <span class="text-lg leading-none">+</span> <span class="hidden md:inline" data-i18n="btn_add_planet">Nuovo Pianeta</span><span class="md:hidden">Nuovo</span>
            </button>
        </div>
        
        <div id="planetList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-12"></div>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-[#161b22]/95 backdrop-blur-lg border-t border-ogame-accent/50 py-3 md:py-4 z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
        <div class="max-w-7xl mx-auto flex flex-row justify-around items-center px-4 gap-2 md:gap-4">
            <div class="text-center w-1/2">
                <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-bold" data-i18n="footer_prod_hour">Produzione Oraria</div>
                <div class="text-2xl md:text-3xl font-bold text-ogame-accent drop-shadow-[0_0_15px_rgba(51,153,255,0.4)] font-mono" id="resHourly">0</div>
            </div>
            <div class="h-10 w-px bg-gray-700/50"></div>
            <div class="text-center w-1/2 flex flex-col items-center">
                <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-bold text-ogame-warning" data-i18n="footer_pack_day">Pacchetto (24h)</div>
                <div class="flex items-center gap-2 relative group cursor-pointer" onclick="copyToClipboard()" title="Copia Valore">
                    <div class="text-2xl md:text-3xl font-bold text-white drop-shadow-[0_0_15px_rgba(210,153,34,0.4)] font-mono" id="resDaily">0</div>
                    <svg class="w-5 h-5 text-gray-500 group-hover:text-white transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    <span class="tooltip" id="copyTooltip" data-i18n="btn_copy">Copia</span>
                </div>
            </div>
        </div>
    </div>

    <script src="js/lang.js"></script>

    <script>
        let planetCounter = 0;
        let currentTotalDaily = 0; 

        document.addEventListener('langLoaded', () => {
            const data = getDataObject();
            const container = document.getElementById('planetList');
            container.innerHTML = '';
            planetCounter = 0;
            if (data.planets && data.planets.length > 0) {
                data.planets.forEach(p => {
                    planetCounter++;
                    container.insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter, p));
                });
            } else { addPlanet(); }
            renumberPlanets();
            calculateAll();
        });

        // --- TEMPLATE CARD DINAMICO ---
        function getPlanetHTML(id, data = null) {
            const v = data || {
                metal: 30, crystal: 0, deuterium: 0, 
                pos: 8, item: 0, itemCustom: 0, magma: 0, human: 0,
                crawlers: 0, overload: false
            };

            const inputStyle = "w-full bg-[#0d1014] border border-gray-700 rounded px-3 py-2 text-white text-sm focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent outline-none transition font-mono";
            const labelStyle = "block text-[11px] uppercase font-bold text-gray-500 mb-1";
            const lfLabelStyle = "block text-[11px] uppercase font-bold text-gray-500 mb-1 min-h-[32px] flex items-end pb-1";

            return `
                <div class="bg-ogame-panel border border-gray-700/50 rounded-xl p-5 hover:border-ogame-accent/50 transition duration-300 relative group flex flex-col shadow-lg card" id="card-${id}">
                    <div class="flex justify-between items-center mb-5 pb-3 border-b border-gray-800">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-gray-400 font-bold text-xs border border-gray-700 planet-index">#${id}</div>
                            <span class="font-bold text-gray-300">${t('lbl_planet')}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clonePlanet(${id})" class="px-3 py-1.5 bg-blue-900/40 hover:bg-blue-600 border border-blue-800/50 text-blue-200 text-xs rounded transition flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                <span class="hidden sm:inline">${t('btn_clone')}</span>
                            </button>
                            <button onclick="removePlanet(${id})" class="px-3 py-1.5 bg-red-900/40 hover:bg-red-600 border border-red-800/50 text-red-200 text-xs rounded transition flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                <span class="hidden sm:inline">${t('btn_delete')}</span>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-4 flex-grow">
                        <div class="bg-gray-800/20 p-3 rounded-lg border border-gray-700/30">
                            <div class="mb-3">
                                <label class="${labelStyle} text-ogame-accent">${t('lbl_mine_metal')}</label>
                                <input type="number" class="p-metal ${inputStyle} border-ogame-accent/30" value="${v.metal}" onchange="calculateAll()">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="${labelStyle}">${t('lbl_mine_crystal')}</label><input type="number" class="p-crystal ${inputStyle}" value="${v.crystal}" placeholder="0" onchange="calculateAll()"></div>
                                <div><label class="${labelStyle}">${t('lbl_mine_deuterium')}</label><input type="number" class="p-deuterium ${inputStyle}" value="${v.deuterium}" placeholder="0" onchange="calculateAll()"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="${labelStyle}">${t('lbl_position')}</label>
                                <select class="p-pos ${inputStyle}" onchange="calculateAll()">
                                    <option value="8" ${v.pos == 8 ? 'selected' : ''}>Pos 8 (x1.35)</option>
                                    <option value="7" ${v.pos == 7 ? 'selected' : ''}>Pos 7 (x1.23)</option>
                                    <option value="9" ${v.pos == 9 ? 'selected' : ''}>Pos 9 (x1.23)</option>
                                    <option value="6" ${v.pos == 6 ? 'selected' : ''}>Pos 6 (x1.17)</option>
                                    <option value="10" ${v.pos == 10 ? 'selected' : ''}>Pos 10 (x1.17)</option>
                                    <option value="1" ${v.pos == 1 ? 'selected' : ''}>Standard</option>
                                </select>
                            </div>
                            <div>
                                <label class="${labelStyle}">${t('lbl_item')} & Custom %</label>
                                <div class="flex gap-2">
                                    <select class="p-item w-1/2 bg-[#0d1014] border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-ogame-accent outline-none transition" onchange="calculateAll()">
                                        <option value="0" ${v.item == 0 ? 'selected' : ''}>-</option>
                                        <option value="10" ${v.item == 10 ? 'selected' : ''}>10%</option>
                                        <option value="20" ${v.item == 20 ? 'selected' : ''}>20%</option>
                                        <option value="30" ${v.item == 30 ? 'selected' : ''}>30%</option>
                                        <option value="40" ${v.item == 40 ? 'selected' : ''}>40%</option>
                                    </select>
                                    <input type="number" class="p-item-custom w-1/2 bg-[#0d1014] border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-ogame-accent outline-none text-center" 
                                        value="${v.itemCustom}" placeholder="%" onchange="calculateAll()">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 items-end">
                            <div><label class="${lfLabelStyle}">${t('lbl_magma')}</label><input type="number" class="p-magma ${inputStyle}" value="${v.magma}" placeholder="0" onchange="calculateAll()"></div>
                            <div><label class="${lfLabelStyle}">${t('lbl_human')}</label><input type="number" class="p-human ${inputStyle}" value="${v.human}" placeholder="0" onchange="calculateAll()"></div>
                        </div>
                        <div class="pt-4 border-t border-gray-800">
                            <div class="flex justify-between items-center mb-1">
                                 <label class="${labelStyle} text-ogame-warning mb-0">${t('lbl_crawlers')}</label>
                                 <span class="text-[10px] text-gray-500">${t('lbl_max_supported')} <span class="text-ogame-warning font-bold p-max-crawlers-disp">0</span></span>
                            </div>
                            <input type="number" class="p-crawlers-input ${inputStyle} border-ogame-warning/30 focus:border-ogame-warning focus:ring-ogame-warning" value="${v.crawlers}" placeholder="0" onchange="calculateAll()">
                            <div class="flex items-center justify-between mt-2">
                                <label class="flex items-center space-x-2 cursor-pointer group">
                                    <input type="checkbox" class="p-overload w-4 h-4 accent-ogame-warning rounded bg-gray-800 border-gray-600 transition" onchange="calculateAll()" ${v.overload ? 'checked' : ''}>
                                    <span class="text-[10px] text-gray-400 group-hover:text-ogame-warning transition">${t('lbl_overload')}</span>
                                </label>
                                <div class="text-[9px] text-gray-500 italic p-crawler-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="breakdown bg-black/30 p-4 rounded-lg mt-5 font-mono text-[11px] border border-gray-800 space-y-1" id="breakdown-${id}"></div>
                </div>
            `;
        }

        function renumberPlanets() {
            document.querySelectorAll('.planet-index').forEach((el, i) => el.innerText = '#' + (i + 1));
            updateBadge();
        }
        function addPlanet() { planetCounter++; document.getElementById('planetList').insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter)); renumberPlanets(); calculateAll(); }
        function clonePlanet(id) { const data = extractPlanetData(document.getElementById(`card-${id}`)); planetCounter++; document.getElementById('planetList').insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter, data)); renumberPlanets(); calculateAll(); }
        function removePlanet(id) { const el = document.getElementById(`card-${id}`); if(el) el.remove(); renumberPlanets(); calculateAll(); }
        function updateBadge() { document.getElementById('planetCountBadge').innerText = document.querySelectorAll('.card').length; }
        
        function applyBulk() {
            const target = document.getElementById('bulkTarget').value;
            const val = parseInt(document.getElementById('bulkValue').value) || 0;
            if(document.getElementById('bulkValue').value === "") return;
            document.querySelectorAll('.card').forEach(card => {
                let sel = ''; let isChk = false;
                switch(target) {
                    case 'metal': sel='.p-metal'; break; case 'crystal': sel='.p-crystal'; break; case 'deuterium': sel='.p-deuterium'; break;
                    case 'item': sel='.p-item'; break; case 'itemCustom': sel='.p-item-custom'; break; case 'pos': sel='.p-pos'; break;
                    case 'magma': sel='.p-magma'; break; case 'human': sel='.p-human'; break; case 'crawlers': sel='.p-crawlers-input'; break;
                    case 'overload': sel='.p-overload'; isChk=true; break;
                }
                if(sel) { const el = card.querySelector(sel); if(el) isChk ? el.checked = (val===1) : el.value = val; }
            });
            calculateAll();
        }

        function extractPlanetData(card) {
            return {
                metal: card.querySelector('.p-metal').value, crystal: card.querySelector('.p-crystal').value, deuterium: card.querySelector('.p-deuterium').value,
                pos: card.querySelector('.p-pos').value, item: card.querySelector('.p-item').value, itemCustom: card.querySelector('.p-item-custom').value,
                magma: card.querySelector('.p-magma').value, human: card.querySelector('.p-human').value, crawlers: card.querySelector('.p-crawlers-input').value,
                overload: card.querySelector('.p-overload').checked
            };
        }

        function formatNum(n) { return new Intl.NumberFormat('it-IT').format(Math.floor(n)); }

        function calculateAll() {
            const globalData = {
                ecoSpeed: parseFloat(document.getElementById('ecoSpeed').value)||1, plasmaLvl: parseFloat(document.getElementById('plasmaLevel').value)||0,
                playerClass: document.getElementById('playerClass').value, allyClass: document.getElementById('allyClass').value,
                geologist: document.getElementById('geologist').checked, staff: document.getElementById('staff').checked,
                lfGlobalBonus: parseFloat(document.getElementById('lfGlobalBonus').value)||0
            };
            let totalHourly = 0;

            document.querySelectorAll('.card').forEach(card => {
                const pid = card.id.split('-')[1];
                const p = extractPlanetData(card);
                const met=parseInt(p.metal)||0, cry=parseInt(p.crystal)||0, deu=parseInt(p.deuterium)||0, 
                      pos=parseInt(p.pos), item=parseInt(p.item), itemCust=parseInt(p.itemCustom)||0,
                      magma=parseInt(p.magma)||0, human=parseInt(p.human)||0, craw=parseInt(p.crawlers)||0, over=p.overload;

                let posMult = 1.0;
                if(pos==8) posMult=1.35; else if(pos==7||pos==9) posMult=1.23; else if(pos==6||pos==10) posMult=1.17;
                
                const natProd = 30 * globalData.ecoSpeed * posMult;
                let mineBase = 0;
                if(met>0) mineBase = Math.floor(30 * globalData.ecoSpeed * posMult * met * Math.pow(1.1, met));

                let bonuses = []; let totPerc = 0;
                if(globalData.plasmaLvl>0) { bonuses.push({n:'Plasma', v: globalData.plasmaLvl}); totPerc+=globalData.plasmaLvl; }
                if(globalData.geologist) { bonuses.push({n:t('lbl_geo'), v:10}); totPerc+=10; }
                if(globalData.staff) { bonuses.push({n:t('lbl_staff'), v:2}); totPerc+=2; }
                if(globalData.playerClass==='collector') { bonuses.push({n:'Collector', v:25}); totPerc+=25; }
                if(globalData.allyClass==='trader') { bonuses.push({n:'Trader', v:5}); totPerc+=5; }
                if(item>0) { bonuses.push({n:t('lbl_item'), v:item}); totPerc+=item; }
                if(itemCust>0) { bonuses.push({n:'Custom', v:itemCust}); totPerc+=itemCust; }
                if(magma>0) { bonuses.push({n:`Magma (${magma})`, v:magma*2}); totPerc+=magma*2; }
                if(human>0) { bonuses.push({n:`Human (${human})`, v:human*1.5}); totPerc+=human*1.5; }
                if(globalData.lfGlobalBonus>0) { bonuses.push({n:'Tech LF', v:globalData.lfGlobalBonus}); totPerc+=globalData.lfGlobalBonus; }

                const mineSum = met+cry+deu;
                let maxCraw = mineSum*8;
                // CAP Crawler: +10% se Collector + Geologist
                if(globalData.playerClass==='collector' && globalData.geologist) maxCraw = Math.floor(maxCraw*1.1);
                
                card.querySelector('.p-max-crawlers-disp').innerText = maxCraw;
                const actCraw = Math.min(craw, maxCraw);
                const fb = card.querySelector('.p-crawler-feedback');
                if(craw > maxCraw) fb.innerHTML=`<span class="text-ogame-warning">${t('msg_crawler_cap')}</span>`;
                else if(craw>0) fb.innerText=""; else fb.innerText=t('msg_crawler_none');

                if(actCraw>0) {
                    // LOGICA CRAWLER FACTOR: 0.02 base
                    let uB = 0.02;
                    if(globalData.playerClass==='collector') { 
                        uB*=1.5; // +50% Classe
                        if(over) uB*=1.5; // +50% Overload (SOLO SE COLLECTOR)
                    }
                    let cP = actCraw*uB;
                    bonuses.push({n:`Crawler (${actCraw})`, v:cP}); totPerc+=cP;
                }

                const bonusProd = Math.floor(mineBase * (totPerc/100));
                const pTot = Math.floor(natProd + mineBase + bonusProd);
                totalHourly += pTot;

                let html = `<div class="flex justify-between text-gray-500"><span>Base</span><span>${formatNum(mineBase)}</span></div>
                            <div class="flex justify-between text-gray-600 text-[10px] mb-2"><span>Nat.</span><span>${formatNum(natProd)}</span></div>
                            <div class="border-t border-gray-700 my-2"></div>`;
                bonuses.forEach(b => {
                    html += `<div class="flex justify-between text-gray-400"><span>${b.n} <span class="text-gray-600 text-[9px]">(+${Number(b.v).toFixed(2)}%)</span></span><span class="text-ogame-success">+${formatNum(Math.floor(mineBase*(b.v/100)))}</span></div>`;
                });
                html += `<div class="border-t border-gray-700 mt-2 pt-2 flex justify-between font-bold text-ogame-accent text-sm"><span>TOT</span><span>${formatNum(pTot)}</span></div>`;
                document.getElementById(`breakdown-${pid}`).innerHTML = html;
            });

            currentTotalDaily = totalHourly * 24;
            document.getElementById('resHourly').innerText = formatNum(totalHourly);
            document.getElementById('resDaily').innerText = formatNum(currentTotalDaily);
            localStorage.setItem('ogameDailyMetal', currentTotalDaily);
            saveToLocalStorage();
        }

        function getDataObject() { 
             const planets = []; document.querySelectorAll('.card').forEach(card => planets.push(extractPlanetData(card)));
             return { global: { ecoSpeed: document.getElementById('ecoSpeed').value, playerClass: document.getElementById('playerClass').value, plasmaLevel: document.getElementById('plasmaLevel').value, lfGlobalBonus: document.getElementById('lfGlobalBonus').value, geologist: document.getElementById('geologist').checked, staff: document.getElementById('staff').checked, allyClass: document.getElementById('allyClass').value }, planets: planets };
        }
        function loadDataObject(data) { 
             if (!data || !data.global) return;
             document.getElementById('ecoSpeed').value = data.global.ecoSpeed; document.getElementById('playerClass').value = data.global.playerClass; document.getElementById('plasmaLevel').value = data.global.plasmaLevel; document.getElementById('lfGlobalBonus').value = data.global.lfGlobalBonus; document.getElementById('geologist').checked = data.global.geologist; document.getElementById('staff').checked = data.global.staff; document.getElementById('allyClass').value = data.global.allyClass;
             const container = document.getElementById('planetList'); container.innerHTML = ''; planetCounter = 0;
             if (data.planets) data.planets.forEach(p => { planetCounter++; container.insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter, p)); }); else addPlanet();
             renumberPlanets(); calculateAll();
        }
        function saveToLocalStorage() { localStorage.setItem('ogameMetalCalcData', JSON.stringify(getDataObject())); }
        function loadFromLocalStorage() { try { loadDataObject(JSON.parse(localStorage.getItem('ogameMetalCalcData'))); } catch(e) { addPlanet(); } }
        function resetAll() { if(confirm("Reset?")) { localStorage.removeItem('ogameMetalCalcData'); location.reload(); } }
        function exportData() {
            const blob = new Blob([JSON.stringify(getDataObject(), null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ogame_metal_config.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function importData(el) {
            const r = new FileReader(); r.onload = e => { try { loadDataObject(JSON.parse(e.target.result)); } catch(err){alert("Error");} }; r.readAsText(el.files[0]); el.value='';
        }
        function copyToClipboard() { navigator.clipboard.writeText(Math.floor(currentTotalDaily)); const t = document.getElementById('copyTooltip'); t.innerText=window.t('copied'); setTimeout(()=>t.innerText=window.t('btn_copy'), 2000); }

        window.onload = loadFromLocalStorage;
    </script>

    <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
    <script>kofiWidgetOverlay.draw('galax95', {'type': 'floating-chat','floating-chat.donateButton.text': 'Support me','floating-chat.donateButton.background-color': '#3399ff','floating-chat.donateButton.text-color': '#fff'});</script>
</body>
</html>
