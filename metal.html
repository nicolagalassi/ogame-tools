<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metal Calculator | OGame Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ogame: {
                            bg: '#0d1014',       
                            panel: '#161b22',    
                            border: '#30363d',   
                            accent: '#3399ff',   
                            success: '#238636',  
                            danger: '#da3633',   
                            warning: '#d29922', 
                            text: '#c9d1d9'
                        }
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Nasconde le frecce negli input number */
        input[type=number]::-webkit-inner-spin-button { opacity: 0; }
        input[type=number]:hover::-webkit-inner-spin-button { opacity: 1; }
    </style>
</head>
<body class="bg-ogame-bg text-ogame-text font-sans pb-32 min-h-screen">

    <header class="relative bg-gradient-to-b from-[#1c2128] to-ogame-bg border-b border-ogame-border pt-8 pb-12 px-4 mb-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <a href="index.html" class="inline-flex items-center text-sm text-gray-500 hover:text-ogame-accent transition mb-2 group">
                    <svg class="w-4 h-4 mr-1 transform group-hover:-translate-x-1 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Torna all'Hub
                </a>
                <h1 class="text-3xl md:text-5xl font-bold text-white tracking-tight">
                    Metal <span class="text-ogame-accent">Calculator</span>
                </h1>
                <p class="text-gray-400 mt-2 max-w-xl text-sm md:text-base">
                    Ottimizza la produzione, gestisci i crawler e calcola il valore esatto dei pacchetti risorse giornalieri.
                </p>
            </div>
            
            <div class="flex gap-2 bg-ogame-panel p-2 rounded-xl border border-ogame-border shadow-lg">
                <button onclick="exportData()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-gray-800 transition text-gray-400 hover:text-white group" title="Scarica configurazione">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    <span class="text-[9px] uppercase font-bold">Salva</span>
                </button>
                
                <div class="w-px bg-gray-700 my-2"></div>
                
                <button onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-gray-800 transition text-gray-400 hover:text-white group" title="Carica file JSON">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span class="text-[9px] uppercase font-bold">Carica</span>
                </button>
                
                <div class="w-px bg-gray-700 my-2"></div>
                
                <button onclick="resetAll()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-red-900/20 transition text-gray-400 hover:text-ogame-danger group" title="Cancella tutto">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span class="text-[9px] uppercase font-bold">Reset</span>
                </button>
                <input type="file" id="fileInput" accept=".json" onchange="importData(this)" class="hidden">
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 md:px-6">
        
        <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-ogame-accent"></div>
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-ogame-accent"></span> Impostazioni Account & Universo
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2">Velocit√† Economia</label>
                        <input type="number" id="ecoSpeed" value="8" min="1" onchange="calculateAll()" 
                            class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent outline-none transition text-lg font-mono">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2">Classe Giocatore</label>
                        <select id="playerClass" onchange="calculateAll()" 
                            class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent outline-none transition">
                            <option value="collector">Collezionista (+25%)</option>
                            <option value="other">Altro / General</option>
                        </select>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2">Livello Plasma</label>
                        <input type="number" id="plasmaLevel" value="0" min="0" onchange="calculateAll()" 
                            class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2">Bonus LifeForms Totale (%)</label>
                        <input type="number" id="lfGlobalBonus" value="0" placeholder="0" onchange="calculateAll()" 
                            class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent outline-none transition placeholder-gray-700">
                    </div>
                </div>

                <div class="space-y-4 pt-1">
                    <label class="flex items-center p-3 rounded-lg border border-gray-700/50 hover:border-gray-600 bg-[#0d1014]/50 cursor-pointer transition group">
                        <input type="checkbox" id="geologist" onchange="calculateAll()" class="w-5 h-5 accent-ogame-accent rounded bg-gray-800 border-gray-600 group-hover:scale-110 transition">
                        <span class="ml-3 font-medium text-gray-300">Geologo (+10%)</span>
                    </label>
                    <label class="flex items-center p-3 rounded-lg border border-gray-700/50 hover:border-gray-600 bg-[#0d1014]/50 cursor-pointer transition group">
                        <input type="checkbox" id="staff" onchange="calculateAll()" class="w-5 h-5 accent-ogame-accent rounded bg-gray-800 border-gray-600 group-hover:scale-110 transition">
                        <span class="ml-3 font-medium text-gray-300">Staff Comando (+2%)</span>
                    </label>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2">Classe Alleanza</label>
                        <select id="allyClass" onchange="calculateAll()" 
                            class="w-full bg-[#0d1014] border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-300 focus:border-ogame-accent outline-none transition">
                            <option value="none">Nessuna</option>
                            <option value="trader">Mercante (+5%)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-3">
                Gestione Pianeti
                <span class="text-xs md:text-sm font-normal text-gray-400 bg-gray-800 px-2 py-1 rounded-md border border-gray-700" id="planetCountBadge">0</span>
            </h2>
            <button onclick="addPlanet()" class="px-4 py-2 md:px-6 md:py-2 bg-ogame-success hover:bg-green-600 text-white text-sm md:text-base font-bold rounded-lg shadow-lg hover:shadow-green-900/30 transition transform hover:-translate-y-0.5 flex items-center gap-2 whitespace-nowrap">
                <span class="text-lg leading-none">+</span> <span class="hidden md:inline">Nuovo Pianeta</span><span class="md:hidden">Nuovo</span>
            </button>
        </div>
        
        <div id="planetList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-12">
            </div>

    </div>

    <div class="fixed bottom-0 left-0 w-full bg-[#161b22]/95 backdrop-blur-lg border-t border-ogame-accent/50 py-3 md:py-4 z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
        <div class="max-w-7xl mx-auto flex flex-row justify-around items-center px-4 gap-2 md:gap-4">
            <div class="text-center w-1/2">
                <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-bold">Produzione Oraria</div>
                <div class="text-2xl md:text-3xl font-bold text-ogame-accent drop-shadow-[0_0_15px_rgba(51,153,255,0.4)] font-mono" id="resHourly">0</div>
            </div>
            <div class="h-10 w-px bg-gray-700/50"></div>
            <div class="text-center w-1/2">
                <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-bold text-ogame-warning">Pacchetto (24h)</div>
                <div class="text-2xl md:text-3xl font-bold text-white drop-shadow-[0_0_15px_rgba(210,153,34,0.4)] font-mono" id="resDaily">0</div>
            </div>
        </div>
    </div>

<script>
    let planetCounter = 0;

    // --- TEMPLATE CARD (JS) ---
    function getPlanetHTML(id, data = null) {
        const v = data || {
            metal: 30, crystal: 0, deuterium: 0, 
            pos: 8, item: 0, magma: 0, 
            crawlers: 0 // Default a 0 o al valore salvato
        };

        const inputStyle = "w-full bg-[#0d1014] border border-gray-700 rounded px-3 py-2 text-white text-sm focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent outline-none transition font-mono";
        const labelStyle = "block text-[11px] uppercase font-bold text-gray-500 mb-1";

        return `
            <div class="bg-ogame-panel border border-gray-700/50 rounded-xl p-5 hover:border-ogame-accent/50 transition duration-300 relative group flex flex-col shadow-lg card" id="card-${id}">
                
                <div class="flex justify-between items-center mb-5 pb-3 border-b border-gray-800">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-gray-400 font-bold text-xs border border-gray-700 planet-index">#${id}</div>
                        <span class="font-bold text-gray-300">Pianeta</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clonePlanet(${id})" class="px-3 py-1.5 bg-blue-900/40 hover:bg-blue-600 border border-blue-800/50 text-blue-200 text-xs rounded transition flex items-center gap-1" title="Clona">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            <span class="hidden sm:inline">Clona</span>
                        </button>
                        <button onclick="removePlanet(${id})" class="px-3 py-1.5 bg-red-900/40 hover:bg-red-600 border border-red-800/50 text-red-200 text-xs rounded transition flex items-center gap-1" title="Rimuovi">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            <span class="hidden sm:inline">Elimina</span>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-4 flex-grow">
                    <div class="bg-gray-800/20 p-3 rounded-lg border border-gray-700/30">
                        <div class="mb-3">
                            <label class="${labelStyle} text-ogame-accent">Miniera Metallo</label>
                            <input type="number" class="p-metal ${inputStyle} border-ogame-accent/30" value="${v.metal}" onchange="calculateAll()">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="${labelStyle}">Miniera Cristallo</label>
                                <input type="number" class="p-crystal ${inputStyle}" value="${v.crystal}" placeholder="0" onchange="calculateAll()">
                            </div>
                            <div>
                                <label class="${labelStyle}">Miniera Deuterio</label>
                                <input type="number" class="p-deuterium ${inputStyle}" value="${v.deuterium}" placeholder="0" onchange="calculateAll()">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="${labelStyle}">Posizione</label>
                            <select class="p-pos ${inputStyle}" onchange="calculateAll()">
                                <option value="8" ${v.pos == 8 ? 'selected' : ''}>Pos 8 (x1.35)</option>
                                <option value="7" ${v.pos == 7 ? 'selected' : ''}>Pos 7 (x1.23)</option>
                                <option value="9" ${v.pos == 9 ? 'selected' : ''}>Pos 9 (x1.23)</option>
                                <option value="6" ${v.pos == 6 ? 'selected' : ''}>Pos 6 (x1.17)</option>
                                <option value="10" ${v.pos == 10 ? 'selected' : ''}>Pos 10 (x1.17)</option>
                                <option value="1" ${v.pos == 1 ? 'selected' : ''}>Standard</option>
                            </select>
                        </div>
                        <div>
                            <label class="${labelStyle}">Item</label>
                            <select class="p-item ${inputStyle}" onchange="calculateAll()">
                                <option value="0" ${v.item == 0 ? 'selected' : ''}>-</option>
                                <option value="10" ${v.item == 10 ? 'selected' : ''}>+10%</option>
                                <option value="20" ${v.item == 20 ? 'selected' : ''}>+20%</option>
                                <option value="30" ${v.item == 30 ? 'selected' : ''}>+30%</option>
                                <option value="40" ${v.item == 40 ? 'selected' : ''}>+40%</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="${labelStyle}">Magma Forge (Livello)</label>
                        <input type="number" class="p-magma ${inputStyle}" value="${v.magma}" placeholder="0" onchange="calculateAll()">
                    </div>

                    <div class="pt-4 border-t border-gray-800">
                        <div class="flex justify-between items-center mb-1">
                             <label class="${labelStyle} text-ogame-warning mb-0">Crawler Assegnati</label>
                             <span class="text-[10px] text-gray-500">Max supportati: <span class="text-ogame-warning font-bold p-max-crawlers-disp">0</span></span>
                        </div>
                        <input type="number" class="p-crawlers-input ${inputStyle} border-ogame-warning/30 focus:border-ogame-warning focus:ring-ogame-warning" 
                            value="${v.crawlers}" placeholder="0" onchange="calculateAll()">
                        <div class="text-[9px] text-gray-500 mt-1 italic p-crawler-feedback"></div>
                    </div>

                </div>

                <div class="breakdown bg-black/30 p-4 rounded-lg mt-5 font-mono text-[11px] border border-gray-800 space-y-1" id="breakdown-${id}">
                    <div class="text-center text-gray-600 italic">Calcolo in attesa...</div>
                </div>
            </div>
        `;
    }

    function renumberPlanets() {
        const indices = document.querySelectorAll('.planet-index');
        indices.forEach((el, index) => {
            el.innerText = '#' + (index + 1);
        });
        updateBadge();
    }

    // --- LOGIC ---

    function addPlanet() {
        planetCounter++;
        const container = document.getElementById('planetList');
        container.insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter));
        renumberPlanets(); 
        calculateAll();
    }

    function clonePlanet(idToClone) {
        const card = document.getElementById(`card-${idToClone}`);
        const data = extractPlanetData(card);
        planetCounter++;
        document.getElementById('planetList').insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter, data));
        renumberPlanets(); 
        calculateAll();
    }

    function removePlanet(id) {
        const el = document.getElementById(`card-${id}`);
        if (el) el.remove();
        renumberPlanets();
        calculateAll();
    }
    
    function updateBadge() {
        const count = document.querySelectorAll('.card').length;
        document.getElementById('planetCountBadge').innerText = count;
    }

    function extractPlanetData(cardElement) {
        return {
            metal: cardElement.querySelector('.p-metal').value,
            crystal: cardElement.querySelector('.p-crystal').value,
            deuterium: cardElement.querySelector('.p-deuterium').value,
            pos: cardElement.querySelector('.p-pos').value,
            item: cardElement.querySelector('.p-item').value,
            magma: cardElement.querySelector('.p-magma').value,
            crawlers: cardElement.querySelector('.p-crawlers-input').value // Legge il numero inserito
        };
    }

    function formatNum(n) {
        return new Intl.NumberFormat('it-IT').format(Math.floor(n));
    }

    function calculateAll() {
        const globalData = {
            ecoSpeed: parseFloat(document.getElementById('ecoSpeed').value) || 1,
            plasmaLvl: parseFloat(document.getElementById('plasmaLevel').value) || 0,
            playerClass: document.getElementById('playerClass').value,
            allyClass: document.getElementById('allyClass').value,
            geologist: document.getElementById('geologist').checked,
            staff: document.getElementById('staff').checked,
            lfGlobalBonus: parseFloat(document.getElementById('lfGlobalBonus').value) || 0
        };

        let totalHourly = 0;

        const cards = document.querySelectorAll('.card');
        
        cards.forEach(card => {
            const pid = card.id.split('-')[1];
            const pData = extractPlanetData(card);

            const metalLvl = parseInt(pData.metal) || 0;
            const crystalLvl = parseInt(pData.crystal) || 0;
            const deuteriumLvl = parseInt(pData.deuterium) || 0;
            const pos = parseInt(pData.pos);
            const itemPerc = parseInt(pData.item);
            const magmaLvl = parseInt(pData.magma) || 0;
            const inputCrawlers = parseInt(pData.crawlers) || 0; // Numero inserito manuale

            // A. Posizione
            let posMultiplier = 1.0;
            let posPercLabel = "0";
            if (pos === 8) { posMultiplier = 1.35; posPercLabel = "35"; }
            else if (pos === 7 || pos === 9) { posMultiplier = 1.23; posPercLabel = "23"; }
            else if (pos === 6 || pos === 10) { posMultiplier = 1.17; posPercLabel = "17"; }

            // B. Naturale
            const naturalProd = 30 * globalData.ecoSpeed * posMultiplier;

            // C. Base Miniera
            let mineBase = 0;
            if (metalLvl > 0) {
                const baseFactor = 30 * globalData.ecoSpeed * posMultiplier;
                mineBase = Math.floor(baseFactor * metalLvl * Math.pow(1.1, metalLvl));
            }

            // D. Bonus
            let bonuses = []; 
            let totalPercent = 0;

            if (globalData.plasmaLvl > 0) { const val = globalData.plasmaLvl * 1; bonuses.push({name: `Plasma`, val: val}); totalPercent += val; }
            if (globalData.geologist) { bonuses.push({name: "Geologo", val: 10}); totalPercent += 10; }
            if (globalData.staff) { bonuses.push({name: "Staff", val: 2}); totalPercent += 2; }
            if (globalData.playerClass === 'collector') { bonuses.push({name: "Collector", val: 25}); totalPercent += 25; }
            
            if (globalData.allyClass === 'trader') { bonuses.push({name: "Trader", val: 5}); totalPercent += 5; }
            
            if (itemPerc > 0) { bonuses.push({name: "Item", val: itemPerc}); totalPercent += itemPerc; }
            if (magmaLvl > 0) { const val = magmaLvl * 2; bonuses.push({name: `Magma (${magmaLvl})`, val: val}); totalPercent += val; }
            if (globalData.lfGlobalBonus > 0) { bonuses.push({name: "Tech LF", val: globalData.lfGlobalBonus}); totalPercent += globalData.lfGlobalBonus; }
            
            // --- CRAWLER LOGIC UPDATED ---
            const mineSum = metalLvl + crystalLvl + deuteriumLvl;
            const maxCrawlers = mineSum * 8;
            
            // Update UI Max Display
            card.querySelector('.p-max-crawlers-disp').innerText = maxCrawlers;
            
            // Calcola effettivi: Minimo tra quelli inseriti e il cap massimo
            let activeCrawlers = Math.min(inputCrawlers, maxCrawlers);
            
            // Feedback visivo se l'input supera il max
            const feedbackEl = card.querySelector('.p-crawler-feedback');
            if (inputCrawlers > maxCrawlers) {
                feedbackEl.innerHTML = `<span class="text-ogame-warning">Limitati a ${maxCrawlers} (Cap Miniere)</span>`;
            } else if (inputCrawlers > 0) {
                feedbackEl.innerText = "";
            } else {
                feedbackEl.innerText = "Nessun crawler attivo";
            }

            if (activeCrawlers > 0) {
                const crawlerFactor = (globalData.playerClass === 'collector') ? 0.03 : 0.02; 
                let crawlerPerc = activeCrawlers * crawlerFactor;
                bonuses.push({name: `Crawler (${activeCrawlers})`, val: crawlerPerc}); 
                totalPercent += crawlerPerc; 
            }

            // E. Totale
            const bonusProduction = Math.floor(mineBase * (totalPercent / 100));
            const planetTotal = Math.floor(naturalProd + mineBase + bonusProduction);

            totalHourly += planetTotal;

            // F. Render Breakdown
            let detailsHTML = `
                <div class="flex justify-between text-gray-500">
                    <span>Base (+${posPercLabel}%)</span> 
                    <span>${formatNum(mineBase)}</span>
                </div>
                <div class="flex justify-between text-gray-600 text-[10px] mb-2">
                    <span>Naturale</span> 
                    <span>${formatNum(naturalProd)}</span>
                </div>
                <div class="border-t border-gray-700 my-2"></div>
            `;
            
            bonuses.forEach(b => {
                const val = Math.floor(mineBase * (b.val / 100));
                const percDisplay = Number(b.val).toFixed(2).replace(/[.,]00$/, ""); 
                detailsHTML += `
                <div class="flex justify-between text-gray-400">
                    <span>${b.name} <span class="text-gray-600 text-[9px]">(+${percDisplay}%)</span></span> 
                    <span class="text-ogame-success">+${formatNum(val)}</span>
                </div>`;
            });

            detailsHTML += `
                <div class="border-t border-gray-700 mt-2 pt-2 flex justify-between font-bold text-ogame-accent text-sm">
                    <span>TOTALE</span>
                    <span>${formatNum(planetTotal)}</span>
                </div>
            `;
            
            document.getElementById(`breakdown-${pid}`).innerHTML = detailsHTML;
        });

        document.getElementById('resHourly').innerText = formatNum(totalHourly);
        document.getElementById('resDaily').innerText = formatNum(totalHourly * 24);

        saveToLocalStorage();
    }

    // --- STORAGE ---
    function getDataObject() {
        const planets = [];
        document.querySelectorAll('.card').forEach(card => {
            planets.push(extractPlanetData(card));
        });
        return {
            global: {
                ecoSpeed: document.getElementById('ecoSpeed').value,
                playerClass: document.getElementById('playerClass').value,
                plasmaLevel: document.getElementById('plasmaLevel').value,
                lfGlobalBonus: document.getElementById('lfGlobalBonus').value,
                geologist: document.getElementById('geologist').checked,
                staff: document.getElementById('staff').checked,
                allyClass: document.getElementById('allyClass').value
            },
            planets: planets
        };
    }

    function loadDataObject(data) {
        if (!data || !data.global) return;
        document.getElementById('ecoSpeed').value = data.global.ecoSpeed;
        document.getElementById('playerClass').value = data.global.playerClass;
        document.getElementById('plasmaLevel').value = data.global.plasmaLevel;
        document.getElementById('lfGlobalBonus').value = data.global.lfGlobalBonus;
        document.getElementById('geologist').checked = data.global.geologist;
        document.getElementById('staff').checked = data.global.staff;
        document.getElementById('allyClass').value = data.global.allyClass;

        const container = document.getElementById('planetList');
        container.innerHTML = ''; 
        planetCounter = 0;

        if (data.planets && data.planets.length > 0) {
            data.planets.forEach(p => {
                planetCounter++;
                container.insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter, p));
            });
        } else {
            addPlanet();
        }
        renumberPlanets();
        calculateAll();
    }

    function saveToLocalStorage() {
        const data = getDataObject();
        localStorage.setItem('ogameMetalCalcData', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        const stored = localStorage.getItem('ogameMetalCalcData');
        if (stored) {
            try { loadDataObject(JSON.parse(stored)); } 
            catch (e) { addPlanet(); }
        } else {
            addPlanet();
        }
    }

    function exportData() {
        const data = getDataObject();
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ogame_metal_config.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function importData(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                loadDataObject(JSON.parse(e.target.result));
            } catch (err) { alert("Errore file JSON"); }
        };
        reader.readAsText(file);
        inputElement.value = '';
    }

    function resetAll() {
        if(confirm("Cancellare tutto e ripristinare?")) {
            localStorage.removeItem('ogameMetalCalcData');
            location.reload();
        }
    }

    window.onload = loadFromLocalStorage;
</script>

</body>
</html>