<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pack Exchange | OValue</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { ogame: { bg: '#0d1014', panel: '#161b22', border: '#30363d', accent: '#3399ff', success: '#238636', danger: '#da3633', warning: '#d29922', dm: '#7834bc', money: '#2ea043', text: '#c9d1d9' } }, fontFamily: { sans: ['Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'], mono: ['Consolas', 'Monaco', 'monospace'] } } } }
    </script>
    <style>input[type=number]::-webkit-inner-spin-button{opacity:0}input[type=number]:hover::-webkit-inner-spin-button{opacity:1}</style>
</head>
<body class="bg-ogame-bg text-ogame-text font-sans pb-32 min-h-screen">

    <header class="relative bg-gradient-to-b from-[#1c2128] to-ogame-bg border-b border-ogame-border pt-8 pb-12 px-4 mb-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <a href="index.html" class="inline-flex items-center text-sm text-gray-500 hover:text-ogame-accent transition mb-2 group">
                    <svg class="w-4 h-4 mr-1 transform group-hover:-translate-x-1 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    <span data-i18n="nav_back">Torna a OValue</span>
                </a>
                <h1 class="text-3xl md:text-5xl font-bold text-white tracking-tight">
                    <span data-i18n="pack_calc_title">Pack Exchange</span>
                </h1>
                <p class="text-gray-400 mt-2 max-w-xl text-sm md:text-base" data-i18n="pack_calc_desc">
                    Converti costi in MSE, calcola pacchetti necessari e ottimizza l'acquisto di Materia Oscura in Euro.
                </p>
            </div>
            
            <div class="flex gap-2 bg-ogame-panel p-2 rounded-xl border border-ogame-border shadow-lg">
                 <button onclick="resetFields()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-red-900/20 transition text-gray-400 hover:text-ogame-danger group">
                    <svg class="w-5 h-5 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span class="text-[9px] uppercase font-bold" data-i18n="btn_reset">Reset</span>
                </button>

                <div class="w-px bg-gray-700 my-2"></div>

                <div class="relative" id="lang-component">
                    <button id="lang-btn" onclick="toggleLangDropdown()" class="flex flex-col items-center justify-center w-16 h-14 rounded-lg hover:bg-gray-800 transition text-gray-400 hover:text-white outline-none">
                        <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg>
                        <span id="langLabel" class="text-[9px] font-bold uppercase">IT</span>
                    </button>

                    <div id="lang-dropdown-menu" class="hidden absolute right-0 top-full mt-2 w-36 bg-[#161b22] border border-gray-700 rounded-xl shadow-2xl z-50 transform opacity-0 scale-95 transition-all duration-150 origin-top-right overflow-hidden">
                        <div class="py-1">
                            <button onclick="selectLang('it')" class="lang-option w-full text-left px-4 py-3 text-xs font-bold flex items-center gap-3 hover:bg-gray-800 transition border-b border-gray-700/50 last:border-0" data-lang="it">
                                <span class="text-lg">ðŸ‡®ðŸ‡¹</span> Italiano
                            </button>
                            <button onclick="selectLang('en')" class="lang-option w-full text-left px-4 py-3 text-xs font-bold flex items-center gap-3 hover:bg-gray-800 transition" data-lang="en">
                                <span class="text-lg">ðŸ‡¬ðŸ‡§</span> English
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 md:px-6">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                
                <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-green-600"></div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        <span data-i18n="builder_title">Costruttore / Pianificatore</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                        <div class="md:col-span-1">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1" data-i18n="lbl_category">Categoria</label>
                            <select id="builderCat" onchange="toggleBuilderFields()" class="w-full bg-[#0d1014] border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-green-500 outline-none">
                                <option value="resources" data-i18n="cat_resources">Risorse</option>
                                <option value="facilities" data-i18n="cat_facilities">Strutture</option>
                                <option value="research" data-i18n="cat_research">Ricerche</option>
                                <option value="fleet" data-i18n="cat_fleet">Flotta/Difesa</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1" data-i18n="lbl_element">Elemento</label>
                            <select id="builderItem" class="w-full bg-[#0d1014] border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-green-500 outline-none">
                                </select>
                        </div>
                        <div class="md:col-span-1" id="fieldLevelContainer">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1" data-i18n="lbl_level" id="lblLevel">Livello</label>
                            <input type="number" id="builderLevel" placeholder="1" min="1" class="w-full bg-[#0d1014] border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-green-500 outline-none font-mono">
                        </div>
                        <div class="md:col-span-1 relative" id="fieldMultContainer">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1" data-i18n="lbl_planets" id="lblMult">NÂ° Pianeti</label>
                            <div class="flex items-center">
                                <span class="absolute left-3 text-gray-500 text-sm font-bold" id="multPrefix">x</span>
                                <input type="number" id="builderMult" value="1" min="1" class="w-full bg-[#0d1014] border border-gray-700 rounded pl-6 pr-2 py-2 text-white text-sm focus:border-green-500 outline-none font-mono">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-[10px] uppercase font-bold text-ogame-warning mb-1" data-i18n="lbl_min_level">Liv. Centro Mineralogia</label>
                        <input type="number" id="mineralogyLevel" placeholder="0" min="0" value="0" class="w-24 bg-[#0d1014] border border-ogame-warning/50 rounded px-2 py-1 text-white text-xs focus:border-ogame-warning outline-none font-mono">
                    </div>
                    
                    <button onclick="addToQueue()" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded text-sm transition shadow-md mb-4" data-i18n="btn_add_queue">
                        Aggiungi alla Lista
                    </button>

                    <div id="builderQueue" class="bg-[#0d1014]/50 border border-gray-700 rounded-lg p-3 min-h-[50px] max-h-[150px] overflow-y-auto space-y-1 text-xs font-mono">
                        <div class="text-center text-gray-600 italic" data-i18n="queue_empty">Lista vuota</div>
                    </div>
                </div>

                <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-ogame-accent"></div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-ogame-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span data-i18n="import_title">Importa da OGLight</span>
                    </h3>
                    
                    <div class="relative">
                        <textarea id="pasteArea" rows="4" data-i18n="import_placeholder" placeholder="Incolla qui i costi..." 
                            class="w-full bg-[#0d1014] border border-gray-700 rounded-lg p-4 text-sm text-gray-300 focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent outline-none transition font-mono resize-none"></textarea>
                        
                        <div class="absolute bottom-3 right-3 flex items-center gap-2 bg-[#161b22] p-1 rounded-lg border border-gray-700/50 shadow-lg">
                            <div class="flex items-center bg-[#0d1014] rounded border border-gray-700 px-2 py-1" title="Moltiplicatore (es. x12 pianeti)">
                                <span class="text-xs text-gray-500 font-bold mr-1">x</span>
                                <input type="number" id="parseMultiplier" value="1" min="1" 
                                    class="w-8 bg-transparent text-white text-xs font-bold focus:outline-none text-right font-mono">
                            </div>
                            <button onclick="parseString()" class="px-4 py-1.5 bg-ogame-accent hover:bg-blue-600 text-white text-xs font-bold rounded shadow transition" data-i18n="btn_extract">
                                ESTRAI
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl relative">
                    <h3 class="text-lg font-bold text-white mb-6" data-i18n="lbl_costs">Costi Risorse Totali</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="relative group">
                            <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="res_metal">Metallo</label>
                            <input type="text" id="costMetal" placeholder="0" oninput="formatInput(this); calculate()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg p-3 text-white focus:border-ogame-accent outline-none font-mono text-lg cursor-not-allowed opacity-70">
                        </div>
                        <div class="relative group">
                            <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="res_crystal">Cristallo</label>
                            <input type="text" id="costCrystal" placeholder="0" oninput="formatInput(this); calculate()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg p-3 text-white focus:border-green-500 outline-none font-mono text-lg cursor-not-allowed opacity-70">
                        </div>
                        <div class="relative group">
                            <label class="block text-xs uppercase font-bold text-gray-500 mb-2" data-i18n="res_deuterium">Deuterio</label>
                            <input type="text" id="costDeut" placeholder="0" oninput="formatInput(this); calculate()" class="w-full bg-[#0d1014] border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none font-mono text-lg cursor-not-allowed opacity-70">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-gray-400 uppercase" data-i18n="lbl_rates">Tasso (Met : Cri : Deu)</h3>
                            <button onclick="setRate(3,2,1)" class="text-[10px] bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded border border-gray-600 text-gray-300">Default 3:2:1</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="rateMet" value="3" readonly class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-center text-gray-500 font-bold focus:outline-none cursor-not-allowed">
                            <span class="text-gray-500">:</span>
                            <input type="number" id="rateCry" value="2" onchange="calculate()" class="w-full bg-[#0d1014] border border-gray-700 rounded p-2 text-center text-green-400 font-bold focus:border-green-500 outline-none">
                            <span class="text-gray-500">:</span>
                            <input type="number" id="rateDeut" value="1" onchange="calculate()" class="w-full bg-[#0d1014] border border-gray-700 rounded p-2 text-center text-blue-400 font-bold focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl">
                        <h3 class="text-sm font-bold text-gray-400 uppercase mb-4" data-i18n="lbl_pack_val">Valore Pacchetto (Metallo)</h3>
                        <div class="relative">
                            <input type="text" id="packValue" value="300.000.000" oninput="formatInput(this); calculate()" class="w-full bg-[#0d1014] border border-ogame-warning/50 rounded-lg p-3 text-ogame-warning font-bold focus:border-ogame-warning outline-none text-center text-lg shadow-[0_0_10px_rgba(210,153,34,0.1)]">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 font-mono">MET</div>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2 text-center" id="packSourceLabel" data-i18n="pack_source_manual">Inserisci manuale.</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                
                <div class="bg-ogame-panel border border-ogame-border rounded-xl p-6 shadow-xl flex flex-col justify-center min-h-[220px]">
                    <div class="text-center mb-6">
                        <div class="text-xs text-gray-500 uppercase tracking-widest mb-2" data-i18n="lbl_cost_mse">Costo Totale (MSU)</div>
                        <div id="totalMSE" class="text-3xl font-mono font-bold text-white break-all">0</div>
                    </div>
                    <div class="border-t border-gray-700/50 my-6"></div>
                    <div class="text-center">
                        <div class="text-sm text-ogame-warning uppercase tracking-widest mb-2 font-bold" data-i18n="lbl_packs_needed">Pacchetti Necessari</div>
                        <div id="packsNeeded" class="text-6xl font-bold text-white drop-shadow-[0_0_15px_rgba(210,153,34,0.5)]">0</div>
                    </div>
                </div>

                <div class="bg-ogame-panel border border-ogame-dm/50 rounded-xl p-6 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-1 h-full bg-ogame-dm"></div>
                    <div class="flex flex-col gap-3 mb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-bold text-gray-300 uppercase flex items-center gap-2">
                                <svg class="w-4 h-4 text-ogame-dm" fill="currentColor" viewBox="0 0 20 20"><path d="M13 7H7v6h6V7z"/><path fill-rule="evenodd" d="M7 2a1 1 0 012 0v1h2V2a1 1 0 112 0v1h2a2 2 0 012 2v2h1a1 1 0 110 2h-1v2h1a1 1 0 110 2h-1v2a2 2 0 01-2 2h-2v1a1 1 0 11-2 0v-1H9v1a1 1 0 11-2 0v-1H5a2 2 0 01-2-2v-2H2a1 1 0 110-2h1v-2H2a1 1 0 110-2h1V7a2 2 0 012-2h2V2zM5 7v6h10V7H5z" clip-rule="evenodd"/></svg>
                                <span data-i18n="lbl_cost_dm">Costo MO</span>
                            </h3>
                            <div class="flex items-center justify-between bg-[#0d1014] p-2 rounded border border-gray-700">
                                 <span class="text-[10px] text-gray-400 uppercase font-bold mr-2" data-i18n="lbl_shop_discount">Sconto Shop:</span>
                                 <select id="shopDiscount" onchange="calculate()" class="bg-[#0d1014] text-xs text-white outline-none text-right font-bold cursor-pointer border-none focus:ring-0 w-24">
                                     <option value="0">0%</option>
                                     <option value="20">-20%</option>
                                     <option value="30">-30%</option>
                                 </select>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-[#0d1014] p-2 rounded border border-gray-700">
                             <span class="text-[10px] text-gray-400 uppercase font-bold" data-i18n="lbl_event_bonus">Evento Bonus MO:</span>
                             <select id="moBonus" onchange="calculate()" class="bg-[#0d1014] text-xs text-white outline-none text-right font-bold cursor-pointer border-none focus:ring-0 w-24">
                                 <option value="0">Nessuno</option>
                                 <option value="30">+30% MO</option>
                                 <option value="40">+40% MO</option>
                                 <option value="50">+50% MO</option>
                                 <option value="60">+60% MO</option>
                                 <option value="100">+100% MO</option>
                                 <option value="130">+130% MO</option>
                             </select>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] text-gray-500 uppercase tracking-widest" data-i18n="lbl_cost_dm">Totale MO Necessaria</div>
                        <div id="moTotal" class="text-3xl font-bold text-white drop-shadow-[0_0_15px_rgba(120,52,188,0.5)] mb-1">0</div>
                        <div class="text-[9px] text-gray-400" id="moPerPackLabel"></div>
                    </div>
                </div>

                <div class="bg-ogame-panel border border-ogame-money/50 rounded-xl p-6 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-1 h-full bg-ogame-money"></div>
                    <h3 class="text-sm font-bold text-gray-300 uppercase mb-4 flex items-center gap-2">
                        <span class="text-ogame-money text-lg">â‚¬</span> <span data-i18n="lbl_opt_cost">Stima Costo Ottimizzato</span>
                    </h3>
                    <div id="euroList" class="space-y-2 text-xs text-gray-400 font-mono mb-4 min-h-[40px]"></div>
                    <div class="border-t border-gray-700/50 my-3"></div>
                    <div class="flex justify-between items-end">
                         <span class="text-xs text-gray-500 uppercase font-bold" data-i18n="lbl_total">Totale</span>
                         <span id="euroTotal" class="text-2xl font-bold text-ogame-money">0 â‚¬</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/lang.js"></script>
    <script src="js/ogame_db.js"></script>

    <script>
        const basePacks = [{ cost: 200, amount: 5100000 }, { cost: 100, amount: 2525000 }, { cost: 50, amount: 1140000 }, { cost: 25, amount: 480000 }, { cost: 10, amount: 150000 }, { cost: 5, amount: 60000 }];
        
        let queueItems = [];

        document.addEventListener('langLoaded', () => {
            calculate();
            toggleBuilderFields();
        });

        // --- BUILDER LOGIC ---
        function toggleBuilderFields() {
            const cat = document.getElementById('builderCat').value;
            const items = OGAME_DB[cat].items;
            const itemSelect = document.getElementById('builderItem');
            
            // Popola Select
            itemSelect.innerHTML = "";
            for (const key in items) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = t(key);
                itemSelect.appendChild(opt);
            }

            // Mostra/Nascondi e Rinomina
            const levelCont = document.getElementById('fieldLevelContainer');
            const multCont = document.getElementById('fieldMultContainer');
            const lblLevel = document.getElementById('lblLevel');
            const lblMult = document.getElementById('lblMult');
            const multPrefix = document.getElementById('multPrefix');

            if (cat === 'fleet') {
                // Flotta: No Livello, Moltiplicatore diventa QuantitÃ 
                levelCont.classList.add('hidden');
                multCont.classList.remove('hidden');
                lblMult.innerText = t('lbl_quantity');
                multPrefix.innerText = '';
                document.getElementById('builderMult').placeholder = "1";
            } else if (cat === 'research') {
                // Ricerche: Si Livello, No Moltiplicatore (Fisso a 1)
                levelCont.classList.remove('hidden');
                multCont.classList.add('hidden');
                lblLevel.innerText = t('lbl_level');
                document.getElementById('builderMult').value = 1;
            } else {
                // Strutture: Si Livello, Si Moltiplicatore (Pianeti)
                levelCont.classList.remove('hidden');
                multCont.classList.remove('hidden');
                lblLevel.innerText = t('lbl_level');
                lblMult.innerText = t('lbl_planets');
                multPrefix.innerText = 'x';
            }
        }

        function addToQueue() {
            const cat = document.getElementById('builderCat').value;
            const itemKey = document.getElementById('builderItem').value;
            const level = parseInt(document.getElementById('builderLevel').value) || 1;
            let multiplier = parseInt(document.getElementById('builderMult').value) || 1;
            
            // Level Mineralogia (0-100)
            const minLevel = parseInt(document.getElementById('mineralogyLevel').value) || 0;
            
            // Force mult=1 per Ricerche
            if (cat === 'research') multiplier = 1;

            const itemData = OGAME_DB[cat].items[itemKey];
            let costM=0, costC=0, costD=0;

            if (itemData.type === 'unit') {
                // Flotta (QuantitÃ  Ã¨ nel moltiplicatore)
                costM = itemData.b[0] * multiplier;
                costC = itemData.b[1] * multiplier;
                costD = itemData.b[2] * multiplier;
            } else {
                // Strutture/Ricerche
                const factor = Math.pow(itemData.f, level - 1);
                costM = Math.floor(itemData.b[0] * factor);
                costC = Math.floor(itemData.b[1] * factor);
                costD = Math.floor(itemData.b[2] * factor);

                // SCONTO MINERALOGIA (Solo per Miniere Met/Cri/Deu)
                if (['metal_mine', 'crystal_mine', 'deuterium_synthesizer'].includes(itemKey)) {
                    let discount = Math.min(0.5, minLevel * 0.005); // 0.5% per livello, max 50%
                    if (discount > 0) {
                        costM = Math.floor(costM * (1 - discount));
                        costC = Math.floor(costC * (1 - discount));
                        costD = Math.floor(costD * (1 - discount));
                    }
                }

                // Applica Moltiplicatore Pianeti
                costM *= multiplier;
                costC *= multiplier;
                costD *= multiplier;
            }

            // Aggiungi all'array
            queueItems.push({
                nameKey: itemKey,
                level: level,
                mult: multiplier,
                cat: cat,
                m: costM, c: costC, d: costD
            });

            renderQueue();
        }

        function removeFromQueue(index) {
            queueItems.splice(index, 1);
            renderQueue();
        }

        function renderQueue() {
            const queueDiv = document.getElementById('builderQueue');
            queueDiv.innerHTML = "";

            if (queueItems.length === 0) {
                queueDiv.innerHTML = `<div class="text-center text-gray-600 italic">${t('queue_empty')}</div>`;
            } else {
                queueItems.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center text-gray-300 border-b border-gray-700/50 pb-1 last:border-0";
                    
                    let infoText = "";
                    if(item.cat === 'fleet') infoText = `(${t('lbl_quantity')}: ${item.mult})`;
                    else if(item.cat === 'research') infoText = `(Lvl: ${item.level})`;
                    else if(item.cat === 'import') infoText = "";
                    else infoText = `(Lvl: ${item.level} - ${item.mult}x)`;

                    row.innerHTML = `
                        <div class="flex items-center gap-2">
                            <button onclick="removeFromQueue(${idx})" class="text-red-500 hover:text-red-400 font-bold px-1">âœ•</button>
                            <div>
                                <span class="text-white font-bold">${t(item.nameKey)}</span> <span class="text-[10px] text-gray-500">${infoText}</span>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-400 font-mono text-right">
                            <span class="text-gray-500">M:</span>${formatShort(item.m)} <span class="text-green-900">C:</span>${formatShort(item.c)} <span class="text-blue-900">D:</span>${formatShort(item.d)}
                        </div>
                    `;
                    queueDiv.appendChild(row);
                });
            }
            updateMainInputs();
        }

        function updateMainInputs() {
            let totalM = 0, totalC = 0, totalD = 0;
            queueItems.forEach(i => { totalM += i.m; totalC += i.c; totalD += i.d; });

            document.getElementById('costMetal').value = new Intl.NumberFormat('it-IT').format(totalM);
            document.getElementById('costCrystal').value = new Intl.NumberFormat('it-IT').format(totalC);
            document.getElementById('costDeut').value = new Intl.NumberFormat('it-IT').format(totalD);
            calculate();
        }

        function formatShort(num) {
            if(num >= 1000000000) return (num/1000000000).toFixed(1) + 'G';
            if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if(num >= 1000) return (num/1000).toFixed(1) + 'K';
            return num;
        }

        // --- CALCOLO & PARSING ---
        function formatInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') { input.value = ''; return; }
            input.value = new Intl.NumberFormat('it-IT').format(BigInt(value));
        }
        function getRawValue(id) { const val = document.getElementById(id).value.replace(/\./g, ''); return val === '' ? 0 : parseInt(val); }
        function setRate(m, c, d) { document.getElementById('rateCry').value = c; document.getElementById('rateDeut').value = d; calculate(); }
        
        function resetFields() { 
            queueItems = [];
            renderQueue(); // Questo resetterÃ  anche gli input a 0
            document.getElementById('pasteArea').value = ''; 
            document.getElementById('shopDiscount').value = "0"; document.getElementById('moBonus').value = "0"; document.getElementById('parseMultiplier').value = "1"; 
            calculate(); 
        }

        function parseString() {
            const text = document.getElementById('pasteArea').value;
            const multiplier = parseInt(document.getElementById('parseMultiplier').value) || 1;
            let m=0, c=0, d=0;
            const regexMet = /([\d\.]+)\s*Metallo/gi, regexCry = /([\d\.]+)\s*Cristallo/gi, regexDeut = /([\d\.]+)\s*Deuterio/gi;
            let match;
            while ((match = regexMet.exec(text)) !== null) m += parseInt(match[1].replace(/\./g, '')) || 0;
            while ((match = regexCry.exec(text)) !== null) c += parseInt(match[1].replace(/\./g, '')) || 0;
            while ((match = regexDeut.exec(text)) !== null) d += parseInt(match[1].replace(/\./g, '')) || 0;
            
            m *= multiplier; c *= multiplier; d *= multiplier;
            
            if (m>0 || c>0 || d>0) {
                // Aggiungi come riga speciale in Coda
                queueItems.push({
                    nameKey: 'imported_data', // Chiave per traduzione
                    level: '-',
                    mult: multiplier,
                    cat: 'import',
                    m: m, c: c, d: d
                });
                renderQueue();
            } else if (text.trim().length > 0) alert("Nessuna risorsa trovata.");
        }

        function calculate() {
            const met = getRawValue('costMetal'), cry = getRawValue('costCrystal'), deut = getRawValue('costDeut');
            const rM = 3.0, rC = parseFloat(document.getElementById('rateCry').value)||2, rD = parseFloat(document.getElementById('rateDeut').value)||1;
            const packVal = getRawValue('packValue');
            const shopDiscount = parseFloat(document.getElementById('shopDiscount').value) || 0;
            const bonusPercent = parseInt(document.getElementById('moBonus').value);

            const totalMSE = met + (cry * (rM/rC)) + (deut * (rM/rD));
            let packs = 0;
            if (packVal > 0 && totalMSE > 0) packs = Math.ceil(totalMSE / packVal);

            const basePackPrice = 60000;
            const moPerPackCost = basePackPrice * (1 - (shopDiscount / 100));
            const totalMONeeded = packs * moPerPackCost;

            document.getElementById('totalMSE').innerText = new Intl.NumberFormat('it-IT').format(Math.ceil(totalMSE));
            document.getElementById('packsNeeded').innerText = new Intl.NumberFormat('it-IT').format(packs);
            document.getElementById('moTotal').innerText = new Intl.NumberFormat('it-IT').format(totalMONeeded);
            document.getElementById('moPerPackLabel').innerText = `${new Intl.NumberFormat('it-IT').format(moPerPackCost)} MO / pack`;

            calculateSmartEuro(totalMONeeded, bonusPercent);
        }

        function calculateSmartEuro(targetMO, bonusPercent) {
            if (targetMO <= 0) { renderResult(0, []); return; }
            const bonusMultiplier = 1 + (bonusPercent / 100);
            const currentPacks = basePacks.map(p => ({ cost: p.cost, amount: Math.floor(p.amount * bonusMultiplier) }));
            let bestSolution = findBestCombination(targetMO, currentPacks);
            renderResult(bestSolution.totalCost, bestSolution.packList);
        }

        function findBestCombination(target, packs) {
            if (target <= 0) return { totalCost: 0, packList: [] };
            let currentPack = packs[0];
            let countA = Math.ceil(target / currentPack.amount);
            let costA = countA * currentPack.cost;
            if (packs.length === 1) return { totalCost: costA, packList: [{ count: countA, pack: currentPack }] };
            let countB = Math.floor(target / currentPack.amount);
            let remainder = target - (countB * currentPack.amount);
            let subResult = findBestCombination(remainder, packs.slice(1));
            let costB = (countB * currentPack.cost) + subResult.totalCost;
            if (costA <= costB) return { totalCost: costA, packList: [{ count: countA, pack: currentPack }] };
            else {
                let listB = subResult.packList;
                if (countB > 0) listB.push({ count: countB, pack: currentPack });
                return { totalCost: costB, packList: listB };
            }
        }

        function renderResult(cost, list) {
            document.getElementById('euroTotal').innerText = cost + " â‚¬";
            let displayList = [];
            list.forEach(item => {
                let found = displayList.find(x => x.pack.cost === item.pack.cost);
                if(found) found.count += item.count; else displayList.push({ count: item.count, pack: item.pack });
            });
            displayList.sort((a,b) => b.pack.cost - a.pack.cost);
            let html = '';
            displayList.forEach(item => {
                 html += `
                <div class="flex justify-between items-center border-b border-gray-800 pb-2 last:border-0">
                    <div class="flex flex-col">
                        <span class="text-white font-bold">${item.count}x ${t('shop_list_pack')} ${item.pack.cost} â‚¬</span>
                        <span class="text-[10px] text-gray-500">${t('shop_list_contains')}: ${new Intl.NumberFormat('it-IT').format(item.pack.amount)} ${t('shop_list_each')}</span>
                    </div>
                    <span class="text-ogame-money font-mono font-bold">${(item.count * item.pack.cost)} â‚¬</span>
                </div>`;
            });
            document.getElementById('euroList').innerHTML = html || `<div class="text-center italic opacity-50">${t('shop_list_empty')}</div>`;
        }

        window.onload = function() {
            const cachedMetal = localStorage.getItem('ogameDailyMetal');
            if (cachedMetal) {
                const rawVal = parseInt(cachedMetal);
                if (rawVal > 0) {
                    document.getElementById('packValue').value = new Intl.NumberFormat('it-IT').format(rawVal);
                    const label = document.getElementById('packSourceLabel');
                    if(label) { label.innerText = t('pack_source_auto'); label.classList.add("text-ogame-success"); }
                }
            }
            calculate();
        }
    </script>

    <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
    <script>kofiWidgetOverlay.draw('galax95', {'type': 'floating-chat','floating-chat.donateButton.text': 'Support me','floating-chat.donateButton.background-color': '#3399ff','floating-chat.donateButton.text-color': '#fff'});</script>
</body>
</html>
