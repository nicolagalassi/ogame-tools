<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OGame Metal Tool v1.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ogame: {
                            bg: '#0d1014',       
                            panel: '#161b22',    
                            border: '#30363d',   
                            accent: '#3399ff',   
                            success: '#238636',  
                            danger: '#da3633',   
                            warning: '#d29922',  
                            input: '#0d1014'     
                        }
                    },
                    fontFamily: {
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        input[type=number]::-webkit-inner-spin-button { opacity: 1; }
    </style>
</head>
<body class="bg-ogame-bg text-gray-300 font-sans pb-40 p-4">

<div class="max-w-7xl mx-auto">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <h1 class="text-3xl font-bold text-ogame-accent uppercase tracking-wider">OGame Metal Tool</h1>
        
        <div class="flex flex-wrap gap-3 justify-center">
            <button onclick="exportData()" class="px-4 py-2 bg-gray-800 border border-gray-600 rounded hover:bg-gray-700 transition flex items-center gap-2 text-sm font-medium">
                Esporta
            </button>
            <button onclick="document.getElementById('fileInput').click()" class="px-4 py-2 bg-gray-800 border border-gray-600 rounded hover:bg-gray-700 transition flex items-center gap-2 text-sm font-medium">
                Importa
            </button>
            <button onclick="resetAll()" class="px-4 py-2 bg-ogame-danger/80 hover:bg-ogame-danger text-white rounded transition flex items-center gap-2 text-sm font-medium">
                Reset
            </button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(this)" class="hidden">
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-ogame-panel p-6 rounded-xl border border-ogame-border shadow-lg mb-10">
        
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Universo</h3>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Velocit&agrave; Economia</label>
                <input type="number" id="ecoSpeed" value="8" min="1" onchange="calculateAll()" 
                    class="w-full bg-ogame-input border border-ogame-border rounded px-3 py-2 text-white focus:outline-none focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent transition">
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Classe Giocatore</label>
                <select id="playerClass" onchange="calculateAll()" 
                    class="w-full bg-ogame-input border border-ogame-border rounded px-3 py-2 text-white focus:outline-none focus:border-ogame-accent">
                    <option value="collector">Collezionista (+25% Prod)</option>
                    <option value="other">Altro (Nessun bonus)</option>
                </select>
            </div>
        </div>
        
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Tecnologie</h3>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Livello Plasma (+1%/lvl)</label>
                <input type="number" id="plasmaLevel" value="0" min="0" onchange="calculateAll()" 
                    class="w-full bg-ogame-input border border-ogame-border rounded px-3 py-2 text-white focus:outline-none focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent transition">
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Bonus Tech Forme Vita Totale (%)</label>
                <input type="number" id="lfGlobalBonus" value="0" placeholder="Es. 12.5" onchange="calculateAll()" 
                    class="w-full bg-ogame-input border border-ogame-border rounded px-3 py-2 text-white focus:outline-none focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent transition">
            </div>
        </div>

        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Bonus Extra</h3>
            <div class="flex flex-col gap-3">
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-800 transition">
                    <input type="checkbox" id="geologist" onchange="calculateAll()" class="w-5 h-5 accent-ogame-accent rounded border-gray-600">
                    <span>Geologo (+10%)</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-800 transition">
                    <input type="checkbox" id="staff" onchange="calculateAll()" class="w-5 h-5 accent-ogame-accent rounded border-gray-600">
                    <span>Staff di Comando (+2%)</span>
                </label>
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Classe Alleanza</label>
                <select id="allyClass" onchange="calculateAll()" 
                    class="w-full bg-ogame-input border border-ogame-border rounded px-3 py-2 text-white focus:outline-none focus:border-ogame-accent">
                    <option value="none">Nessuna</option>
                    <option value="trader">Mercante (Trader) +5%</option>
                </select>
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-200">Gestione Pianeti</h2>
        <button onclick="addPlanet()" class="px-5 py-2 bg-ogame-success hover:bg-green-700 text-white font-bold rounded shadow-lg transition flex items-center gap-2">
            <span>+</span> Aggiungi Pianeta
        </button>
    </div>
    
    <div id="planetList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        </div>
    
    <button onclick="calculateAll()" class="w-full mt-10 py-4 bg-ogame-success hover:bg-green-700 text-white text-lg font-bold rounded-xl shadow-lg transition uppercase tracking-wide">
        Ricalcola Tutto
    </button>
</div>

<div class="fixed bottom-0 left-0 w-full bg-[#161b22]/95 backdrop-blur-md border-t-2 border-ogame-accent py-4 z-50 shadow-[0_-5px_25px_rgba(0,0,0,0.8)]">
    <div class="max-w-7xl mx-auto flex justify-around items-center px-4">
        <div class="text-center">
            <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">Produzione Oraria</div>
            <div class="text-2xl md:text-3xl font-bold text-ogame-accent drop-shadow-[0_0_10px_rgba(51,153,255,0.3)]" id="resHourly">0</div>
        </div>
        <div class="h-10 w-px bg-gray-700"></div>
        <div class="text-center">
            <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">Valore Pacchetto (24h)</div>
            <div class="text-2xl md:text-3xl font-bold text-ogame-warning drop-shadow-[0_0_10px_rgba(210,153,34,0.3)]" id="resDaily">0</div>
        </div>
    </div>
</div>

<script>
    let planetCounter = 0;

    // --- TEMPLATE ---
    function getPlanetHTML(id, data = null) {
        const v = data || {
            metal: 30, pos: 8, item: 0, magma: 0, mineSum: 0
        };

        const inputClass = "w-full bg-ogame-input border border-ogame-border rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-ogame-accent focus:ring-1 focus:ring-ogame-accent transition";
        const labelClass = "block text-xs text-gray-500 mb-1 font-medium";

        return `
            <div class="bg-ogame-panel p-5 rounded-lg border border-ogame-border shadow-sm flex flex-col relative hover:border-ogame-accent/50 transition duration-300 card group" id="card-${id}">
                
                <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-700">
                    <span class="font-bold text-ogame-accent">Pianeta #${id}</span>
                    <div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="clonePlanet(${id})" class="px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded transition" title="Clona">
                            Clona
                        </button>
                        <button onclick="removePlanet(${id})" class="px-2 py-1 bg-ogame-danger hover:bg-red-500 text-white text-xs rounded transition" title="Rimuovi">
                            ?
                        </button>
                    </div>
                </div>
                
                <div class="space-y-3 flex-grow">
                    <div>
                        <label class="${labelClass}">Miniera Metallo (Livello)</label>
                        <input type="number" class="p-metal ${inputClass}" value="${v.metal}" onchange="calculateAll()">
                    </div>

                    <div>
                        <label class="${labelClass}">Posizione Sistema</label>
                        <select class="p-pos ${inputClass}" onchange="calculateAll()">
                            <option value="8" ${v.pos == 8 ? 'selected' : ''}>Pos 8 (Base x 1.35)</option>
                            <option value="7" ${v.pos == 7 ? 'selected' : ''}>Pos 7 (Base x 1.23)</option>
                            <option value="9" ${v.pos == 9 ? 'selected' : ''}>Pos 9 (Base x 1.23)</option>
                            <option value="6" ${v.pos == 6 ? 'selected' : ''}>Pos 6 (Base x 1.17)</option>
                            <option value="10" ${v.pos == 10 ? 'selected' : ''}>Pos 10 (Base x 1.17)</option>
                            <option value="1" ${v.pos == 1 ? 'selected' : ''}>Altro (Base x 1.0)</option>
                        </select>
                    </div>

                    <div>
                        <label class="${labelClass}">Item Metallo</label>
                        <select class="p-item ${inputClass}" onchange="calculateAll()">
                            <option value="0" ${v.item == 0 ? 'selected' : ''}>Nessuno</option>
                            <option value="10" ${v.item == 10 ? 'selected' : ''}>Bronzo (10%)</option>
                            <option value="20" ${v.item == 20 ? 'selected' : ''}>Argento (20%)</option>
                            <option value="30" ${v.item == 30 ? 'selected' : ''}>Oro (30%)</option>
                            <option value="40" ${v.item == 40 ? 'selected' : ''}>Platino (40%)</option>
                        </select>
                    </div>

                    <div>
                        <label class="${labelClass}">Magma Forge (Edificio LF)</label>
                        <input type="number" class="p-magma ${inputClass}" value="${v.magma}" placeholder="Livello (2%/lvl)" onchange="calculateAll()">
                    </div>

                    <div class="pt-3 border-t border-gray-700 mt-2">
                        <div>
                            <label class="${labelClass} text-ogame-warning">Somma Livelli Miniere (Met+Cri+Deu)</label>
                            <input type="number" class="p-mine-sum ${inputClass}" value="${v.mineSum}" placeholder="Es. 80 (calcola i crawler)" onchange="calculateAll()">
                        </div>
                    </div>
                </div>

                <div class="breakdown bg-black/40 p-3 rounded mt-4 font-mono text-xs border border-gray-800 space-y-1" id="breakdown-${id}">
                    <div class="text-center text-gray-600">In attesa di calcolo...</div>
                </div>
            </div>
        `;
    }

    // --- LOGICA ---

    function addPlanet() {
        planetCounter++;
        const container = document.getElementById('planetList');
        container.insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter));
        calculateAll();
    }

    function clonePlanet(idToClone) {
        const card = document.getElementById(`card-${idToClone}`);
        const data = extractPlanetData(card);
        planetCounter++;
        document.getElementById('planetList').insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter, data));
        calculateAll();
    }

    function removePlanet(id) {
        const el = document.getElementById(`card-${id}`);
        if (el) el.remove();
        calculateAll();
    }

    function extractPlanetData(cardElement) {
        return {
            metal: cardElement.querySelector('.p-metal').value,
            pos: cardElement.querySelector('.p-pos').value,
            item: cardElement.querySelector('.p-item').value,
            magma: cardElement.querySelector('.p-magma').value,
            mineSum: cardElement.querySelector('.p-mine-sum').value
        };
    }

    function formatNum(n) {
        return new Intl.NumberFormat('it-IT').format(Math.floor(n));
    }

    function calculateAll() {
        const globalData = {
            ecoSpeed: parseFloat(document.getElementById('ecoSpeed').value) || 1,
            plasmaLvl: parseFloat(document.getElementById('plasmaLevel').value) || 0,
            playerClass: document.getElementById('playerClass').value,
            allyClass: document.getElementById('allyClass').value,
            geologist: document.getElementById('geologist').checked,
            staff: document.getElementById('staff').checked,
            lfGlobalBonus: parseFloat(document.getElementById('lfGlobalBonus').value) || 0
        };

        let totalHourly = 0;

        const cards = document.querySelectorAll('.card');
        
        cards.forEach(card => {
            const pid = card.id.split('-')[1];
            const pData = extractPlanetData(card);

            const metalLvl = parseInt(pData.metal) || 0;
            const pos = parseInt(pData.pos);
            const itemPerc = parseInt(pData.item);
            const magmaLvl = parseInt(pData.magma) || 0;
            const mineSum = parseInt(pData.mineSum) || 0;

            // A. Moltiplicatore Posizione
            let posMultiplier = 1.0;
            let posPercLabel = "0";
            if (pos === 8) { posMultiplier = 1.35; posPercLabel = "35"; }
            else if (pos === 7 || pos === 9) { posMultiplier = 1.23; posPercLabel = "23"; }
            else if (pos === 6 || pos === 10) { posMultiplier = 1.17; posPercLabel = "17"; }

            // B. Produzione NATURALE
            const naturalProd = 30 * globalData.ecoSpeed * posMultiplier;

            // C. Produzione MINIERA
            let mineBase = 0;
            if (metalLvl > 0) {
                const baseFactor = 30 * globalData.ecoSpeed * posMultiplier;
                mineBase = Math.floor(baseFactor * metalLvl * Math.pow(1.1, metalLvl));
            }

            // D. Bonus Percentuali
            let bonuses = []; 
            let totalPercent = 0;

            if (globalData.plasmaLvl > 0) { const val = globalData.plasmaLvl * 1; bonuses.push({name: `Plasma`, val: val}); totalPercent += val; }
            if (globalData.geologist) { bonuses.push({name: "Geologo", val: 10}); totalPercent += 10; }
            if (globalData.staff) { bonuses.push({name: "Staff", val: 2}); totalPercent += 2; }
            if (globalData.playerClass === 'collector') { bonuses.push({name: "Collector", val: 25}); totalPercent += 25; }
            if (globalData.allyClass === 'trader') { bonuses.push({name: "Trader", val: 5}); totalPercent += 5; }
            if (itemPerc > 0) { bonuses.push({name: "Item", val: itemPerc}); totalPercent += itemPerc; }
            if (magmaLvl > 0) { const val = magmaLvl * 2; bonuses.push({name: `Magma (${magmaLvl})`, val: val}); totalPercent += val; }
            if (globalData.lfGlobalBonus > 0) { bonuses.push({name: "Tech LF", val: globalData.lfGlobalBonus}); totalPercent += globalData.lfGlobalBonus; }
            
            // AUTOMATIC CRAWLERS CALCULATION
            // Formula: CrawlerCount = MineSum * 8
            const activeCrawlers = mineSum * 8;
            
            if (activeCrawlers > 0) {
                const crawlerFactor = (globalData.playerClass === 'collector') ? 0.03 : 0.02; 
                let crawlerPerc = activeCrawlers * crawlerFactor;
                
                bonuses.push({name: `Crawler (${activeCrawlers})`, val: crawlerPerc}); 
                totalPercent += crawlerPerc; 
            }

            // E. Totale
            const bonusProduction = Math.floor(mineBase * (totalPercent / 100));
            const planetTotal = Math.floor(naturalProd + mineBase + bonusProduction);

            totalHourly += planetTotal;

            // F. HTML Breakdown
            let detailsHTML = `
                <div class="flex justify-between text-gray-400">
                    <span>Base Min. (+${posPercLabel}%)</span> 
                    <span>${formatNum(mineBase)}</span>
                </div>
                <div class="flex justify-between text-gray-500 text-[10px] mb-1">
                    <span>Naturale</span> 
                    <span>${formatNum(naturalProd)}</span>
                </div>
                <div class="border-t border-gray-700 my-1"></div>
            `;
            
            bonuses.forEach(b => {
                const val = Math.floor(mineBase * (b.val / 100));
                const percDisplay = Number(b.val).toFixed(2).replace(/[.,]00$/, ""); 
                detailsHTML += `
                <div class="flex justify-between">
                    <span>${b.name} <span class="text-gray-500 text-[10px]">(+${percDisplay}%)</span></span> 
                    <span class="text-ogame-success">+${formatNum(val)}</span>
                </div>`;
            });

            detailsHTML += `
                <div class="border-t border-gray-600 my-1 pt-1 flex justify-between font-bold text-ogame-accent text-sm">
                    <span>Totale/h</span>
                    <span>${formatNum(planetTotal)}</span>
                </div>
            `;
            
            document.getElementById(`breakdown-${pid}`).innerHTML = detailsHTML;
        });

        document.getElementById('resHourly').innerText = formatNum(totalHourly);
        document.getElementById('resDaily').innerText = formatNum(totalHourly * 24);

        saveToLocalStorage();
    }

    // --- STORAGE & EXPORT ---
    function getDataObject() {
        const planets = [];
        document.querySelectorAll('.card').forEach(card => {
            planets.push(extractPlanetData(card));
        });
        return {
            global: {
                ecoSpeed: document.getElementById('ecoSpeed').value,
                playerClass: document.getElementById('playerClass').value,
                plasmaLevel: document.getElementById('plasmaLevel').value,
                lfGlobalBonus: document.getElementById('lfGlobalBonus').value,
                geologist: document.getElementById('geologist').checked,
                staff: document.getElementById('staff').checked,
                allyClass: document.getElementById('allyClass').value
            },
            planets: planets
        };
    }

    function loadDataObject(data) {
        if (!data || !data.global) return;
        document.getElementById('ecoSpeed').value = data.global.ecoSpeed;
        document.getElementById('playerClass').value = data.global.playerClass;
        document.getElementById('plasmaLevel').value = data.global.plasmaLevel;
        document.getElementById('lfGlobalBonus').value = data.global.lfGlobalBonus;
        document.getElementById('geologist').checked = data.global.geologist;
        document.getElementById('staff').checked = data.global.staff;
        document.getElementById('allyClass').value = data.global.allyClass;

        const container = document.getElementById('planetList');
        container.innerHTML = ''; 
        planetCounter = 0;

        if (data.planets && data.planets.length > 0) {
            data.planets.forEach(p => {
                planetCounter++;
                container.insertAdjacentHTML('beforeend', getPlanetHTML(planetCounter, p));
            });
        } else {
            addPlanet();
        }
        calculateAll();
    }

    function saveToLocalStorage() {
        const data = getDataObject();
        localStorage.setItem('ogameMetalCalcData', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        const stored = localStorage.getItem('ogameMetalCalcData');
        if (stored) {
            try { loadDataObject(JSON.parse(stored)); } 
            catch (e) { addPlanet(); }
        } else {
            addPlanet();
        }
    }

    function exportData() {
        const data = getDataObject();
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ogame_config_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function importData(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                loadDataObject(JSON.parse(e.target.result));
                alert("Dati importati!");
            } catch (err) { alert("Errore file JSON"); }
        };
        reader.readAsText(file);
        inputElement.value = '';
    }

    function resetAll() {
        if(confirm("Cancellare tutto?")) {
            localStorage.removeItem('ogameMetalCalcData');
            location.reload();
        }
    }

    window.onload = loadFromLocalStorage;
</script>

</body>
</html>